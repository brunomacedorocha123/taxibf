<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - ScanHub</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #44689a;
            --secondary-color: #33c47;
            --light-color: #e8ecef;
            --dark-color: #2c3e50;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .navbar-brand img {
            height: 60px;
            transform: scale(2);
            transform-origin: left center;
        }

        .container-main {
            max-width: 1000px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .profile-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #666;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload {
            text-align: center;
            margin-top: 15px;
        }

        .avatar-upload-btn {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
        }

        .avatar-upload-btn:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }

        .btn-remove-avatar {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .btn-remove-avatar:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .section-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-control {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(68, 104, 154, 0.1);
        }

        .form-control[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
            color: #666;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .verification-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }

        .verification-status {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-verified {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-not-verified {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: #f8f9fa;
        }

        .upload-area i {
            font-size: 3rem;
            color: #aaa;
            margin-bottom: 15px;
        }

        .requirements-list {
            background: #fff8e1;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .requirements-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .requirements-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .requirements-list i.fa-times {
            color: #dc3545;
        }

        .requirements-list i.fa-check {
            color: #28a745;
        }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #856404;
        }

        .warning-box i {
            margin-right: 10px;
        }

        .btn-save {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            display: block;
            width: 100%;
            margin-top: 20px;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3);
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #44689a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container-main {
                padding: 0 15px;
                margin: 20px auto;
            }
            
            .profile-header, .section-card {
                padding: 20px;
            }
            
            .profile-avatar {
                width: 100px;
                height: 100px;
                font-size: 2.5rem;
            }
        }

        @media (max-width: 576px) {
            .section-title {
                font-size: 1.1rem;
            }
            
            .form-control {
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg bg-white shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="dashboard-cliente.html">
                <img src="logotrampiza.png" alt="ScanHub">
            </a>
            <div class="d-flex">
                <a href="cliente-dashboard.html" class="btn btn-outline-primary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Voltar
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-main">
        <!-- Profile Header -->
        <div class="profile-header text-center">
            <div class="profile-avatar" id="avatarDisplay">
                <i class="fas fa-user"></i>
            </div>
            
            <h2 id="userName">Carregando...</h2>
            <p class="text-muted" id="userEmail">carregando@email.com</p>
            
            <div class="avatar-upload">
                <label class="avatar-upload-btn">
                    <i class="fas fa-camera me-2"></i>Alterar Foto
                    <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                </label>
                <button class="btn-remove-avatar" id="btnRemoverFoto" style="display: none;">
                    <i class="fas fa-trash me-2"></i>Remover Foto
                </button>
            </div>
        </div>

        <!-- Dados do Cadastro (Somente Leitura) -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-id-card"></i>Dados do Cadastro
            </h3>
            <p class="text-muted mb-4">Estes dados foram registrados no seu cadastro e não podem ser alterados.</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i>Nome Completo
                        </label>
                        <input type="text" class="form-control" id="nomeCompleto" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-smile"></i>Como quer ser chamado
                        </label>
                        <input type="text" class="form-control" id="apelido" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i>E-mail
                        </label>
                        <input type="email" class="form-control" id="email" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-phone"></i>Celular/WhatsApp
                        </label>
                        <input type="text" class="form-control" id="celular" readonly>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-birthday-cake"></i>Data de Nascimento
                        </label>
                        <input type="text" class="form-control" id="dataNascimento" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-hashtag"></i>ID ScanHub
                        </label>
                        <input type="text" class="form-control" id="idScanHub" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados Faltantes (Para Completar) -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-edit"></i>Complete seu Perfil
            </h3>
            <p class="text-muted mb-4">Preencha os dados abaixo para melhorar sua experiência na plataforma.</p>
            
            <!-- CPF/CNPJ -->
            <div class="form-group">
                <label for="cpfCnpj" class="form-label">
                    <i class="fas fa-id-card"></i>CPF ou CNPJ
                </label>
                <input type="text" class="form-control" id="cpfCnpj" 
                       placeholder="Digite seu CPF ou CNPJ">
            </div>

            <!-- Endereço -->
            <h5 class="mt-4 mb-3"><i class="fas fa-home me-2"></i>Endereço</h5>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" class="form-control" id="cep" placeholder="00000-000">
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="form-group">
                        <label for="logradouro" class="form-label">Rua/Avenida</label>
                        <input type="text" class="form-control" id="logradouro" placeholder="Nome da rua">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="numero" class="form-label">Número</label>
                        <input type="text" class="form-control" id="numero" placeholder="123">
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label for="complemento" class="form-label">Complemento</label>
                        <input type="text" class="form-control" id="complemento" placeholder="Apto 101">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="bairro" placeholder="Bairro">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="cidade" class="form-label">Cidade</label>
                        <input type="text" class="form-control" id="cidade" placeholder="Cidade">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-control" id="estado">
                            <option value="">Selecione</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Configurações de Contato -->
            <h5 class="mt-4 mb-3"><i class="fas fa-shield-alt me-2"></i>Configurações de Contato</h5>
            
            <div class="checkbox-group">
                <input type="checkbox" id="mostrarContato" checked>
                <label for="mostrarContato" class="mb-0">
                    Mostrar meu contato para profissionais
                </label>
            </div>
            <small class="text-muted">Quando desativado, os profissionais não verão seu telefone/email.</small>
        </div>

        <!-- Verificação de Documento -->
        <div class="section-card">
            <h3 class="section-title">
                <i class="fas fa-user-check"></i>Verificação de Identidade
            </h3>
            
            <div class="verification-card">
                <!-- Status da Verificação -->
                <div class="verification-status status-not-verified" id="verificationStatus">
                    <i class="fas fa-times-circle me-2"></i>NÃO VERIFICADO
                </div>
                
                <p class="mb-4">Para sua segurança e dos profissionais, verifique sua identidade enviando uma selfie segurando seu documento.</p>
                
                <!-- Upload Area -->
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h5>Arraste e solte sua foto aqui</h5>
                    <p class="text-muted">ou clique para selecionar</p>
                    <input type="file" id="documentPhoto" accept="image/*" style="display: none;">
                </div>
                
                <!-- Preview da Imagem -->
                <img id="imagePreview" class="preview-image" alt="Pré-visualização">
                
                <!-- Requisitos -->
                <div class="requirements-list">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Requisitos obrigatórios:</h6>
                    <ul>
                        <li><i class="fas fa-times text-danger"></i> Proibido usar boné ou chapéu</li>
                        <li><i class="fas fa-times text-danger"></i> Sem óculos escuros ou acessórios no rosto</li>
                        <li><i class="fas fa-times text-danger"></i> Imagem nítida e bem iluminada</li>
                        <li><i class="fas fa-times text-danger"></i> Documento legível próximo ao rosto</li>
                        <li><i class="fas fa-times text-danger"></i> Seu rosto deve estar completamente visível</li>
                    </ul>
                </div>
                
                <!-- Mensagem de Prazo -->
                <div class="warning-box">
                    <i class="fas fa-clock"></i>
                    <strong>Prazo de validação:</strong> Após o envio, nossa equipe tem até 48 horas úteis para validar sua documentação.
                </div>
                
                <!-- Instrução para enviar -->
                <div class="text-center mt-4">
                    <button class="btn btn-save" id="btnEnviarVerificacao" disabled>
                        <i class="fas fa-paper-plane me-2"></i>Enviar para Verificação
                    </button>
                    <small class="text-muted d-block mt-2">
                        Após o envio, você não poderá alterar a foto até a validação ser concluída.
                    </small>
                </div>
            </div>
        </div>

        <!-- Botão Salvar Tudo -->
        <div class="section-card">
            <button class="btn btn-save" id="btnSalvarTudo">
                <i class="fas fa-save me-2"></i>Salvar Todas as Alterações
            </button>
        </div>
    </div>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase + Script Principal -->
    <script>
    // ==========================================
    // CONFIGURAÇÃO IMGUR (MESMA DO SCANHUB)
    // ==========================================
    const IMGUR_CLIENT_ID = '546c25a59c58ad7';
    const USER_DATA_KEY = 'taxibf_motorista_perfil';

    // ==========================================
    // DADOS DO USUÁRIO - CARREGADOS DO SEU SISTEMA
    // ==========================================
    let userData = {
        uid: 'xTLxTX594cePkAT3GOTLoby0aPp2',
        fullName: 'Bruno Felix Macedo Rocha',
        email: 'brunomacedorocha123@gmail.com',
        phone: '',
        cpf: '',
        bio: '',
        userType: 'taxi',
        photoURL: null,
        status: 'available',
        createdAt: '2026-02-11T12:27:36.000Z',
        lastStatusUpdate: '2026-02-11T12:28:19.000Z',
        stats: {
            totalRides: 0,
            rating: 0,
            favorites: 0,
            todayRides: 0
        },
        vehicle: {
            plate: '',
            model: '',
            year: '',
            color: '',
            alvara: '',
            permissao: ''
        },
        taxi: {
            plate: '',
            model: '',
            year: '',
            color: '',
            alvara: '',
            permissao: '',
            photos: [null, null, null, null, null]
        },
        moto: {
            plate: '',
            model: '',
            year: '',
            color: '',
            alvara: '',
            capacete: '',
            photos: [null, null, null, null, null]
        },
        documents: {
            cnh: null,
            crlv: null,
            address: null
        },
        preferences: {
            notifyWhatsApp: true
        }
    };

    // Arrays de fotos
    let taxiPhotos = [null, null, null, null, null];
    let motoPhotos = [null, null, null, null, null];

    // ==========================================
    // ELEMENTOS DOM
    // ==========================================
    const elements = {
        navAvatar: document.getElementById('navAvatar'),
        profilePlaceholder: document.getElementById('profilePlaceholder'),
        profilePhoto: document.getElementById('profilePhoto'),
        fileInput: document.getElementById('fileInput'),
        displayName: document.getElementById('displayName'),
        displayEmail: document.getElementById('displayEmail'),
        profileStatus: document.getElementById('profileStatus'),
        fullName: document.getElementById('fullName'),
        cpf: document.getElementById('cpf'),
        phone: document.getElementById('phone'),
        email: document.getElementById('email'),
        bio: document.getElementById('bio'),
        typeTaxi: document.getElementById('typeTaxi'),
        typeMoto: document.getElementById('typeMoto'),
        vehicleTaxiSection: document.getElementById('vehicleTaxiSection'),
        vehicleMotoSection: document.getElementById('vehicleMotoSection'),
        plate: document.getElementById('plate'),
        carModel: document.getElementById('carModel'),
        carYear: document.getElementById('carYear'),
        carColor: document.getElementById('carColor'),
        alvara: document.getElementById('alvara'),
        permissao: document.getElementById('permissao'),
        motoPlate: document.getElementById('motoPlate'),
        motoModel: document.getElementById('motoModel'),
        motoYear: document.getElementById('motoYear'),
        motoColor: document.getElementById('motoColor'),
        motoAlvara: document.getElementById('motoAlvara'),
        motoCapacete: document.getElementById('motoCapacete'),
        notifyWhatsApp: document.getElementById('notifyWhatsApp'),
        deactivateAccount: document.getElementById('deactivateAccount'),
        btnSave: document.getElementById('btnSave'),
        btnReset: document.getElementById('btnReset'),
        btnLogout: document.getElementById('btnLogout'),
        toast: document.getElementById('toast'),
        toastTitle: document.getElementById('toastTitle'),
        toastMessage: document.getElementById('toastMessage'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        loadingMessage: document.getElementById('loadingMessage'),
        vehiclePhotoInput: document.getElementById('vehiclePhotoInput'),
        motoPhotoInput: document.getElementById('motoPhotoInput'),
        documentInput: document.getElementById('documentInput'),
        cnhStatus: document.getElementById('cnhStatus'),
        cnhBadge: document.getElementById('cnhBadge'),
        crlvStatus: document.getElementById('crlvStatus'),
        crlvBadge: document.getElementById('crlvBadge'),
        addressStatus: document.getElementById('addressStatus'),
        addressBadge: document.getElementById('addressBadge')
    };

    // ==========================================
    // FUNÇÕES UTILITÁRIAS
    // ==========================================
    
    function showLoading(message = 'Carregando...') {
        if (elements.loadingMessage) elements.loadingMessage.textContent = message;
        if (elements.loadingOverlay) elements.loadingOverlay.classList.add('active');
    }

    function hideLoading() {
        if (elements.loadingOverlay) elements.loadingOverlay.classList.remove('active');
    }

    function showToast(title, message, type = 'info') {
        if (!elements.toast) return;
        
        elements.toastTitle.textContent = title;
        elements.toastMessage.textContent = message;
        
        elements.toast.className = 'toast show';
        elements.toast.classList.add(type);
        
        const icon = elements.toast.querySelector('.toast-icon i');
        if (icon) {
            if (type === 'success') icon.className = 'fas fa-check-circle';
            else if (type === 'error') icon.className = 'fas fa-exclamation-circle';
            else if (type === 'warning') icon.className = 'fas fa-exclamation-triangle';
            else icon.className = 'fas fa-info-circle';
        }
        
        setTimeout(() => {
            if (elements.toast) elements.toast.classList.remove('show');
        }, 3500);
    }

    function converterParaBase64(arquivo) {
        return new Promise((resolve, reject) => {
            const leitor = new FileReader();
            leitor.onload = () => resolve(leitor.result);
            leitor.onerror = reject;
            leitor.readAsDataURL(arquivo);
        });
    }

    // ==========================================
    // UPLOAD PARA IMGUR - IDÊNTICO AO SCANHUB
    // ==========================================
    async function uploadParaImgur(arquivo) {
        try {
            const base64 = await converterParaBase64(arquivo);
            const base64Data = base64.split(',')[1];
            
            const formData = new FormData();
            formData.append('image', base64Data);
            
            const resposta = await fetch('https://api.imgur.com/3/image', {
                method: 'POST',
                headers: {
                    'Authorization': `Client-ID ${IMGUR_CLIENT_ID}`
                },
                body: formData
            });
            
            const dados = await resposta.json();
            
            if (dados.success) {
                return dados.data.link;
            } else {
                throw new Error(dados.data?.error || 'Erro no upload');
            }
        } catch (erro) {
            console.error('Erro Imgur:', erro);
            throw erro;
        }
    }

    // ==========================================
    // LOCALSTORAGE - PERSISTÊNCIA
    // ==========================================
    
    function saveToLocalStorage() {
        try {
            userData.updatedAt = new Date().toISOString();
            localStorage.setItem(USER_DATA_KEY, JSON.stringify(userData));
            return true;
        } catch (e) {
            console.error('Erro ao salvar localStorage:', e);
            return false;
        }
    }

    function loadFromLocalStorage() {
        try {
            const saved = localStorage.getItem(USER_DATA_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                userData = { ...userData, ...data };
                
                if (userData.taxi?.photos) taxiPhotos = [...userData.taxi.photos];
                if (userData.moto?.photos) motoPhotos = [...userData.moto.photos];
                
                return true;
            }
        } catch (e) {
            console.error('Erro ao carregar localStorage:', e);
        }
        return false;
    }

    // ==========================================
    // FOTO DE PERFIL
    // ==========================================
    
    function displayProfilePhoto(url) {
        if (!elements.profilePhoto || !elements.profilePlaceholder) return;
        
        elements.profilePhoto.src = url;
        elements.profilePhoto.style.display = 'block';
        elements.profilePlaceholder.style.display = 'none';
        userData.photoURL = url;
        saveToLocalStorage();
    }

    async function handlePhotoUpload(file) {
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showToast('Erro', 'Selecione uma imagem válida', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('Erro', 'A imagem deve ter no máximo 5MB', 'error');
            return;
        }
        
        const leitor = new FileReader();
        leitor.onload = (e) => {
            if (elements.profilePhoto && elements.profilePlaceholder) {
                elements.profilePhoto.src = e.target.result;
                elements.profilePhoto.style.display = 'block';
                elements.profilePlaceholder.style.display = 'none';
            }
        };
        leitor.readAsDataURL(file);
        
        showLoading('Enviando foto...');
        
        try {
            const url = await uploadParaImgur(file);
            userData.photoURL = url;
            saveToLocalStorage();
            showToast('Sucesso', 'Foto de perfil atualizada', 'success');
        } catch (erro) {
            showToast('Erro', 'Falha ao enviar imagem', 'error');
            carregarFotoSalva();
        } finally {
            hideLoading();
            if (elements.fileInput) elements.fileInput.value = '';
        }
    }

    function carregarFotoSalva() {
        if (userData.photoURL && elements.profilePhoto && elements.profilePlaceholder) {
            elements.profilePhoto.src = userData.photoURL;
            elements.profilePhoto.style.display = 'block';
            elements.profilePlaceholder.style.display = 'none';
        }
    }

    // ==========================================
    // FOTOS DO TÁXI
    // ==========================================
    
    function displayVehiclePhoto(url, index) {
        const boxes = document.querySelectorAll('#vehiclePhotos .photo-upload-box');
        if (!boxes[index]) return;
        
        const box = boxes[index];
        const labels = ['Frente', 'Traseira', 'Lateral', 'Interior', 'Placa'];
        
        box.innerHTML = `
            <img src="${url}" alt="Foto ${labels[index]}">
            <button class="photo-remove" data-type="taxi" data-index="${index}">
                <i class="fas fa-times"></i>
            </button>
        `;
        box.classList.add('has-image');
    }

    async function handleVehiclePhotoUpload(file, index) {
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showToast('Erro', 'Selecione uma imagem', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('Erro', 'A imagem deve ter no máximo 5MB', 'error');
            return;
        }
        
        const leitor = new FileReader();
        leitor.onload = (e) => displayVehiclePhoto(e.target.result, index);
        leitor.readAsDataURL(file);
        
        showLoading('Enviando foto...');
        
        try {
            const url = await uploadParaImgur(file);
            taxiPhotos[index] = url;
            userData.taxi.photos = taxiPhotos;
            saveToLocalStorage();
            displayVehiclePhoto(url, index);
            showToast('Sucesso', 'Foto adicionada', 'success');
        } catch (erro) {
            showToast('Erro', 'Falha ao enviar imagem', 'error');
        } finally {
            hideLoading();
        }
    }

    function removeVehiclePhoto(index) {
        if (!confirm('Remover esta foto?')) return;
        
        taxiPhotos[index] = null;
        userData.taxi.photos = taxiPhotos;
        saveToLocalStorage();
        
        const boxes = document.querySelectorAll('#vehiclePhotos .photo-upload-box');
        const box = boxes[index];
        const labels = ['Frente', 'Traseira', 'Lateral', 'Interior', 'Placa'];
        
        box.innerHTML = `
            <i class="fas fa-plus"></i>
            <span>${labels[index]}</span>
        `;
        box.classList.remove('has-image');
        
        showToast('Sucesso', 'Foto removida', 'success');
    }

    // ==========================================
    // FOTOS DA MOTO
    // ==========================================
    
    function displayMotoPhoto(url, index) {
        const boxes = document.querySelectorAll('#motoPhotos .photo-upload-box');
        if (!boxes[index]) return;
        
        const box = boxes[index];
        const labels = ['Frente', 'Lateral', 'Traseira', 'Placa', 'Capacete'];
        
        box.innerHTML = `
            <img src="${url}" alt="Foto ${labels[index]}">
            <button class="photo-remove" data-type="moto" data-index="${index}">
                <i class="fas fa-times"></i>
            </button>
        `;
        box.classList.add('has-image');
    }

    async function handleMotoPhotoUpload(file, index) {
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showToast('Erro', 'Selecione uma imagem', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showToast('Erro', 'A imagem deve ter no máximo 5MB', 'error');
            return;
        }
        
        const leitor = new FileReader();
        leitor.onload = (e) => displayMotoPhoto(e.target.result, index);
        leitor.readAsDataURL(file);
        
        showLoading('Enviando foto...');
        
        try {
            const url = await uploadParaImgur(file);
            motoPhotos[index] = url;
            userData.moto.photos = motoPhotos;
            saveToLocalStorage();
            displayMotoPhoto(url, index);
            showToast('Sucesso', 'Foto adicionada', 'success');
        } catch (erro) {
            showToast('Erro', 'Falha ao enviar imagem', 'error');
        } finally {
            hideLoading();
        }
    }

    function removeMotoPhoto(index) {
        if (!confirm('Remover esta foto?')) return;
        
        motoPhotos[index] = null;
        userData.moto.photos = motoPhotos;
        saveToLocalStorage();
        
        const boxes = document.querySelectorAll('#motoPhotos .photo-upload-box');
        const box = boxes[index];
        const labels = ['Frente', 'Lateral', 'Traseira', 'Placa', 'Capacete'];
        
        box.innerHTML = `
            <i class="fas fa-plus"></i>
            <span>${labels[index]}</span>
        `;
        box.classList.remove('has-image');
        
        showToast('Sucesso', 'Foto removida', 'success');
    }

    // ==========================================
    // DOCUMENTOS
    // ==========================================
    
    async function handleDocumentUpload(file, type) {
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showToast('Erro', 'Envie apenas imagens (JPG, PNG)', 'error');
            return;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            showToast('Erro', 'Arquivo muito grande. Máximo 10MB', 'error');
            return;
        }
        
        showLoading('Enviando documento...');
        
        try {
            const url = await uploadParaImgur(file);
            
            const docData = {
                url: url,
                name: file.name,
                type: file.type,
                size: file.size,
                uploadedAt: new Date().toISOString(),
                status: 'pending'
            };
            
            userData.documents[type] = docData;
            saveToLocalStorage();
            
            const statusEl = document.getElementById(`${type}Status`);
            const badgeEl = document.getElementById(`${type}Badge`);
            
            if (statusEl) {
                statusEl.textContent = file.name.length > 40 ? file.name.substring(0, 40) + '...' : file.name;
            }
            if (badgeEl) {
                badgeEl.innerHTML = '<i class="fas fa-check-circle"></i> Enviado';
                badgeEl.classList.add('verified');
            }
            
            showToast('Sucesso', 'Documento enviado', 'success');
        } catch (erro) {
            showToast('Erro', 'Falha ao enviar documento', 'error');
        } finally {
            hideLoading();
        }
    }

    // ==========================================
    // PREENCHER FORMULÁRIO
    // ==========================================
    
    function fillForm() {
        if (elements.fullName) {
            elements.fullName.value = userData.fullName || 'Bruno Felix Macedo Rocha';
            elements.fullName.readOnly = true;
        }
        if (elements.email) {
            elements.email.value = userData.email || 'brunomacedorocha123@gmail.com';
            elements.email.readOnly = true;
        }
        if (elements.cpf) elements.cpf.value = userData.cpf || '';
        if (elements.phone) elements.phone.value = userData.phone || '';
        if (elements.bio) elements.bio.value = userData.bio || '';
        
        if (elements.plate) elements.plate.value = userData.taxi?.plate || userData.vehicle?.plate || '';
        if (elements.carModel) elements.carModel.value = userData.taxi?.model || userData.vehicle?.model || '';
        if (elements.carYear) elements.carYear.value = userData.taxi?.year || userData.vehicle?.year || '';
        if (elements.carColor) elements.carColor.value = userData.taxi?.color || userData.vehicle?.color || '';
        if (elements.alvara) elements.alvara.value = userData.taxi?.alvara || userData.vehicle?.alvara || '';
        if (elements.permissao) elements.permissao.value = userData.taxi?.permissao || userData.vehicle?.permissao || '';
        
        if (elements.motoPlate) elements.motoPlate.value = userData.moto?.plate || '';
        if (elements.motoModel) elements.motoModel.value = userData.moto?.model || '';
        if (elements.motoYear) elements.motoYear.value = userData.moto?.year || '';
        if (elements.motoColor) elements.motoColor.value = userData.moto?.color || '';
        if (elements.motoAlvara) elements.motoAlvara.value = userData.moto?.alvara || '';
        if (elements.motoCapacete) elements.motoCapacete.value = userData.moto?.capacete || '';
        
        if (elements.notifyWhatsApp) elements.notifyWhatsApp.checked = userData.preferences?.notifyWhatsApp !== false;
        if (elements.deactivateAccount) elements.deactivateAccount.checked = userData.status === 'inactive';
        
        updateProfileStatus();
        carregarFotoSalva();
        updateInitials();
        setVehicleType(userData.userType || 'taxi');
        
        if (taxiPhotos) {
            taxiPhotos.forEach((url, index) => {
                if (url) displayVehiclePhoto(url, index);
            });
        }
        
        if (motoPhotos) {
            motoPhotos.forEach((url, index) => {
                if (url) displayMotoPhoto(url, index);
            });
        }
        
        if (userData.documents) {
            if (userData.documents.cnh && elements.cnhStatus) {
                elements.cnhStatus.textContent = userData.documents.cnh.name || 'Documento enviado';
                if (elements.cnhBadge) {
                    elements.cnhBadge.innerHTML = '<i class="fas fa-check-circle"></i> Enviado';
                    elements.cnhBadge.classList.add('verified');
                }
            }
            if (userData.documents.crlv && elements.crlvStatus) {
                elements.crlvStatus.textContent = userData.documents.crlv.name || 'Documento enviado';
                if (elements.crlvBadge) {
                    elements.crlvBadge.innerHTML = '<i class="fas fa-check-circle"></i> Enviado';
                    elements.crlvBadge.classList.add('verified');
                }
            }
            if (userData.documents.address && elements.addressStatus) {
                elements.addressStatus.textContent = userData.documents.address.name || 'Documento enviado';
                if (elements.addressBadge) {
                    elements.addressBadge.innerHTML = '<i class="fas fa-check-circle"></i> Enviado';
                    elements.addressBadge.classList.add('verified');
                }
            }
        }
    }

    function updateInitials() {
        const name = userData.fullName || 'Motorista';
        const initials = name.split(' ')
            .map(n => n[0])
            .join('')
            .substring(0, 2)
            .toUpperCase();
        
        if (elements.navAvatar) elements.navAvatar.textContent = initials;
        if (elements.profilePlaceholder && !userData.photoURL) {
            elements.profilePlaceholder.textContent = initials;
        }
        if (elements.displayName) elements.displayName.textContent = name;
        if (elements.displayEmail) elements.displayEmail.textContent = userData.email || 'Não informado';
    }

    function updateProfileStatus() {
        if (!elements.profileStatus) return;
        
        if (userData.status === 'inactive' || elements.deactivateAccount?.checked) {
            elements.profileStatus.className = 'profile-status inactive';
            elements.profileStatus.innerHTML = '<i class="fas fa-circle"></i> Inativo';
        } else {
            elements.profileStatus.className = 'profile-status';
            elements.profileStatus.innerHTML = '<i class="fas fa-circle"></i> Disponível';
        }
    }

    // ==========================================
    // TIPO DE VEÍCULO
    // ==========================================
    
    function setVehicleType(type) {
        userData.userType = type;
        
        if (type === 'taxi') {
            if (elements.typeTaxi) elements.typeTaxi.classList.add('active');
            if (elements.typeMoto) elements.typeMoto.classList.remove('active');
            if (elements.vehicleTaxiSection) elements.vehicleTaxiSection.style.display = 'block';
            if (elements.vehicleMotoSection) elements.vehicleMotoSection.style.display = 'none';
        } else {
            if (elements.typeMoto) elements.typeMoto.classList.add('active');
            if (elements.typeTaxi) elements.typeTaxi.classList.remove('active');
            if (elements.vehicleMotoSection) elements.vehicleMotoSection.style.display = 'block';
            if (elements.vehicleTaxiSection) elements.vehicleTaxiSection.style.display = 'none';
        }
        
        saveToLocalStorage();
    }

    // ==========================================
    // SALVAR PERFIL
    // ==========================================
    
    function saveProfile() {
        if (!validateForm()) return;
        
        userData.cpf = elements.cpf?.value || '';
        userData.phone = elements.phone?.value || '';
        userData.bio = elements.bio?.value || '';
        
        if (userData.userType === 'taxi') {
            userData.taxi = {
                plate: elements.plate?.value?.toUpperCase() || '',
                model: elements.carModel?.value || '',
                year: elements.carYear?.value || '',
                color: elements.carColor?.value || '',
                alvara: elements.alvara?.value || '',
                permissao: elements.permissao?.value || '',
                photos: taxiPhotos
            };
            userData.vehicle = { ...userData.taxi };
        } else {
            userData.moto = {
                plate: elements.motoPlate?.value?.toUpperCase() || '',
                model: elements.motoModel?.value || '',
                year: elements.motoYear?.value || '',
                color: elements.motoColor?.value || '',
                alvara: elements.motoAlvara?.value || '',
                capacete: elements.motoCapacete?.value || '',
                photos: motoPhotos
            };
        }
        
        userData.preferences = {
            notifyWhatsApp: elements.notifyWhatsApp?.checked || false
        };
        
        userData.status = elements.deactivateAccount?.checked ? 'inactive' : 'available';
        
        saveToLocalStorage();
        updateProfileStatus();
        
        showToast('Sucesso', 'Perfil salvo com sucesso', 'success');
    }

    // ==========================================
    // VALIDAÇÃO
    // ==========================================
    
    function validateForm() {
        let valid = true;
        const required = ['cpf', 'phone'];
        
        if (userData.userType === 'taxi') {
            required.push('plate', 'carModel', 'carYear', 'carColor');
        } else {
            required.push('motoPlate', 'motoModel', 'motoYear', 'motoColor');
        }
        
        required.forEach(id => {
            const el = document.getElementById(id);
            if (el && !el.value?.trim()) {
                el.classList.add('error');
                valid = false;
            } else if (el) {
                el.classList.remove('error');
            }
        });
        
        if (!valid) {
            showToast('Atenção', 'Preencha todos os campos obrigatórios', 'warning');
        }
        
        return valid;
    }

    // ==========================================
    // RESET FORM
    // ==========================================
    
    function resetForm() {
        if (confirm('Limpar todas as alterações não salvas?')) {
            loadFromLocalStorage();
            fillForm();
            showToast('Info', 'Formulário restaurado', 'info');
        }
    }

    // ==========================================
    // POPULAR ANOS
    // ==========================================
    
    function populateYears() {
        const currentYear = new Date().getFullYear();
        
        ['carYear', 'motoYear'].forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">Selecione o ano</option>';
                for (let year = currentYear; year >= 2000; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    select.appendChild(option);
                }
            }
        });
    }

    // ==========================================
    // MÁSCARAS
    // ==========================================
    
    function maskCPF(e) {
        let v = e.target.value.replace(/\D/g, '').substring(0, 11);
        v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})(\d)/, '$1.$2');
        v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        e.target.value = v;
    }

    function maskPhone(e) {
        let v = e.target.value.replace(/\D/g, '').substring(0, 11);
        if (v.length === 11) {
            v = v.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
        } else if (v.length === 10) {
            v = v.replace(/^(\d{2})(\d{4})(\d{4})$/, '($1) $2-$3');
        } else if (v.length > 2) {
            v = v.replace(/^(\d{2})(\d)/, '($1) $2');
        }
        e.target.value = v;
    }

    function maskPlate(e) {
        let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').substring(0, 7);
        if (v.length === 7) {
            if (/^[A-Z]{3}[0-9][A-Z][0-9]{2}$/.test(v)) {
                v = v.replace(/^([A-Z]{3})([0-9])([A-Z])([0-9]{2})$/, '$1$2$3$4');
            } else {
                v = v.replace(/^([A-Z]{3})(\d{4})$/, '$1-$2');
            }
        } else if (v.length > 3) {
            v = v.replace(/^([A-Z]{3})(.+)$/, '$1-$2');
        }
        e.target.value = v;
    }

    // ==========================================
    // LOGOUT
    // ==========================================
    
    function logout() {
        if (confirm('Deseja sair da sua conta?')) {
            window.location.href = 'dashboard-taxi.html';
        }
    }

    // ==========================================
    // EVENT LISTENERS
    // ==========================================
    
    function setupEventListeners() {
        if (elements.fileInput) {
            elements.fileInput.addEventListener('change', (e) => {
                handlePhotoUpload(e.target.files[0]);
            });
        }
        
        document.querySelectorAll('#vehiclePhotos .photo-upload-box').forEach(box => {
            box.addEventListener('click', function(e) {
                if (e.target.classList.contains('photo-remove')) return;
                const index = parseInt(this.dataset.index);
                if (elements.vehiclePhotoInput) {
                    elements.vehiclePhotoInput.dataset.index = index;
                    elements.vehiclePhotoInput.click();
                }
            });
        });
        
        document.querySelectorAll('#motoPhotos .photo-upload-box').forEach(box => {
            box.addEventListener('click', function(e) {
                if (e.target.classList.contains('photo-remove')) return;
                const index = parseInt(this.dataset.index);
                if (elements.motoPhotoInput) {
                    elements.motoPhotoInput.dataset.index = index;
                    elements.motoPhotoInput.click();
                }
            });
        });
        
        if (elements.vehiclePhotoInput) {
            elements.vehiclePhotoInput.addEventListener('change', (e) => {
                const index = parseInt(e.target.dataset.index || '0');
                handleVehiclePhotoUpload(e.target.files[0], index);
                e.target.value = '';
            });
        }
        
        if (elements.motoPhotoInput) {
            elements.motoPhotoInput.addEventListener('change', (e) => {
                const index = parseInt(e.target.dataset.index || '0');
                handleMotoPhotoUpload(e.target.files[0], index);
                e.target.value = '';
            });
        }
        
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.photo-remove');
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            const type = btn.dataset.type;
            const index = parseInt(btn.dataset.index);
            if (type === 'taxi') {
                removeVehiclePhoto(index);
            } else if (type === 'moto') {
                removeMotoPhoto(index);
            }
        });
        
        if (document.getElementById('cnhUpload')) {
            document.getElementById('cnhUpload').addEventListener('click', () => {
                if (elements.documentInput) {
                    elements.documentInput.dataset.type = 'cnh';
                    elements.documentInput.click();
                }
            });
        }
        
        if (document.getElementById('crlvUpload')) {
            document.getElementById('crlvUpload').addEventListener('click', () => {
                if (elements.documentInput) {
                    elements.documentInput.dataset.type = 'crlv';
                    elements.documentInput.click();
                }
            });
        }
        
        if (document.getElementById('addressUpload')) {
            document.getElementById('addressUpload').addEventListener('click', () => {
                if (elements.documentInput) {
                    elements.documentInput.dataset.type = 'address';
                    elements.documentInput.click();
                }
            });
        }
        
        if (elements.documentInput) {
            elements.documentInput.addEventListener('change', (e) => {
                const type = e.target.dataset.type;
                if (type) {
                    handleDocumentUpload(e.target.files[0], type);
                }
                e.target.value = '';
            });
        }
        
        if (elements.typeTaxi) {
            elements.typeTaxi.addEventListener('click', () => setVehicleType('taxi'));
        }
        if (elements.typeMoto) {
            elements.typeMoto.addEventListener('click', () => setVehicleType('moto'));
        }
        
        if (elements.btnSave) {
            elements.btnSave.addEventListener('click', saveProfile);
        }
        if (elements.btnReset) {
            elements.btnReset.addEventListener('click', resetForm);
        }
        if (elements.btnLogout) {
            elements.btnLogout.addEventListener('click', logout);
        }
        
        if (elements.cpf) {
            elements.cpf.addEventListener('input', maskCPF);
        }
        if (elements.phone) {
            elements.phone.addEventListener('input', maskPhone);
        }
        if (elements.plate) {
            elements.plate.addEventListener('input', maskPlate);
        }
        if (elements.motoPlate) {
            elements.motoPlate.addEventListener('input', maskPlate);
        }
        
        if (elements.deactivateAccount) {
            elements.deactivateAccount.addEventListener('change', function() {
                userData.status = this.checked ? 'inactive' : 'available';
                updateProfileStatus();
                saveToLocalStorage();
            });
        }
    }

    // ==========================================
    // INITIALIZATION
    // ==========================================
    
    document.addEventListener('DOMContentLoaded', function() {
        loadFromLocalStorage();
        populateYears();
        fillForm();
        setupEventListeners();
    });
</script>
</body>
</html>